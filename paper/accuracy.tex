\section{Numerical Robustness}

\tkcomment{I use a lot of big words in this section, but I don't know 
what I am doing, so probably at least half is wrong.}

\tkcomment{For the actual paper, maybe put the reasoning behind the
implementation choices here, and move the proofs to an appendix.}

I write $(1 + \delta)$, $|\delta| < ...$, but really mean $I + A$ for some 
$2 \times 2$ matrix such that $\lVert A \rVert < ...$, where the norm
on $A$ is subordinate to the Euclidean norm on $\mathbb{R}^2$ (spectral radius).


\subsection{Accurate Evaluation of Right-Hand Turn}

As discussed, we can decide whether $puq$ makes a right-hand turn by testing
$orient(p, u, q) > 0$. We have $orient(p, u, q) = -orient(u, p, q)$, so
we can equivalently compare

$$(p_x - u_x) \cdot (q_y - p_y) - (p_y - u_y) \cdot (q_x - p_x) < 0 \iff$$
$$(p_x - u_x) \cdot (q_y - p_y) - (p_y - u_y) \cdot (q_x - p_x) < 0 \iff$$
$$(p_x - u_x) \cdot (q_y - p_y) < (p_y - u_y) \cdot (q_x - p_x).$$

The number of operations are the same, but we evaluate this in a loop over $u$, 
so this formulaton has the performance benefit that $q_x - p_x$ and $q_y - p_y$ 
can be lifted out of the loop. We denote the true evaluation of this inequality
by $rt(p, u, q)$ and the computed evaluation by $\widehat{rt}(p, u, q)$.


\begin{lemma}\label{lem:right-turn}
    The computed predicate $\widehat{rt}$ is backward-stable in the 
    following sense. Let $M$ be
    an upper bound on the magnitude of $x$- and $y$-coordinates of points in
    $P$. Then if $\widehat{rt}(p, u, q)$ is true, there exists 
    $\hat{u} = u(1 + \delta)$, $|\delta| < \frac{6\epsilon}{1 - 6\epsilon}M$
    such that $rt(p, \hat{u}, q)$ is true.
\end{lemma}

\begin{proof}
    We write $fl(\cdots)$ for the floating point evaluation of a primitive 
    operation. The IEEE-754 standard satisfies 
    $fl(x \circ y) = (1 + \delta)(x \circ y)$, $|\delta| < \epsilon$ for
    $\circ \in \{+, -, \cdot\}$. This gives us

    $$fl(fl(p_x - u_x) fl(q_y - p_y)) < 
            fl(fl(p_y - u_y) fl(q_x - p_x)) \iff$$
    $$(p_x - u_x) (q_y - p_y) < \frac{(1 + \delta_1)(1 + \delta_2)(1 + \delta_3)}
    {(1 + \delta_4)(1 + \delta_5)(1 + \delta_6)} (p_y - u_y) (q_x - p_x).$$

    By a non-trivial (\tkcomment{but well-known?}) result, there is some $\theta$
    such that

    $$\frac{(1 + \delta_1)(1 + \delta_2)(1 + \delta_3)}{(1 + \delta_4)(1 + \delta_5)(1 + \delta_6)} = 1 + \theta$$

    and $|\theta| \leq \frac{6\epsilon}{1 - 6\epsilon} := \gamma_6$.

    That simplifies the equation to

    $$(p_x - u_x) (q_y - p_y) < (1 + \theta) (p_y - u_y) (q_x - p_x) \iff$$
    $$-\theta (p_y - u_y) (q_x - p_x) < orient(p, u, q).$$

    If $rt(p, u, q)$ is true, we can take $\hat{u} = u$. If it is false,
    we have $orient(p, u, q) \leq 0$, so
    $|orient(p, u, q)| \leq \gamma_6 |(p_y - u_y) (q_x - p_x)|$.

    Recall that 

    $$d(u, pq) = \frac{orient(p, u, q)}{2 \lVert p - q \rVert} \leq$$
    $$\frac{\gamma_6 |(p_y - u_y) (q_x - p_x)|}{2 \sqrt{(q_x - p_x)^2 + (q_y - p_y)^2}} \leq$$
    $$\frac{1}{2}\gamma_6 |p_y - u_y| \leq 
            \frac{1}{2} \gamma_6 (|p_y| + |u_y|)\gamma_6 M = \gamma_6 M.$$

    So we can move $u$ by $\gamma_6 M$ to get $\hat{u}$ that is truly to the 
    left of $pq$.
\end{proof}

\subsection{Accurate Evaluation of Distance Test}

We can test whether $u$ is farther from $pq$ than $u'$ by comparing
$orient(u, p, q)$ to $orient(u', p, q)$. So from a performance standpoint it
is tempting to compute the orientation once for each point, and then do both
the right-turn test and the distance test with this quantity, but this
runs into precision problems. We are not very much concerned with the
subtraction of coordinates because they are input values and hence not
subject to errors (at least errors we control). However, the subtraction 
in the middle does have round-off errors we introduce by the multiplications.

So instead of working with orientations directly, we use that

$$orient(p, u, q) > orient(p, u', q) \iff orient(u, p, q) < orient(u', p, q) 
\iff$$

$$(q_y - p_y) (u_x - u'_x) < (q_x - p_x) (u_y - u'_y).$$

We write $frt(p, q, u, u')$ for the predicate $d(pq, u) > d(pq, u')$,
and $\widehat{frt}(p, q, u, u')$ for the computed predicate.

\begin{lemma}\label{lem:farther}
    The computed predicate $\widehat{frt}$ is backward-stable in the 
    following sense. Let $M$ be an upper bound on the magnitude of 
    $x$- and $y$-coordinates of points in $P$. 
    Then if $\widehat{frt}(p, q, u, u')$ is true, there exists 
    $\hat{u}' = (1 + \delta)u'$, $|\delta| < \frac{6\epsilon}{1 - 6\epsilon}M$
    such that $frt(p, q, \hat{u}, \hat{u}')$ is true.
\end{lemma}

\begin{proof}
    Suppose $\widehat{frt}(p, q, u, u')$ is true. Then analogously to 
    Lemma~\ref{lem:right-turn}, we have

    $$(q_y - p_y) (u_x - u'_x) - (q_x - p_x) (u_y - u'_y) < 
            \theta(q_x - p_x) (u_y - u'_y),$$

    for $|theta| < \gamma_6$. If $frt(p, q, u, u')$ is false, then

    $$(q_y - p_y) (u_x - u'_x) - (q_x - p_x) (u_y - u'_y) \geq 0,$$

    so 

    $$|(q_y - p_y) (u_x - u'_x) - (q_x - p_x) (u_y - u'_y)| \leq 
        |\theta(q_x - p_x) (u_y - u'_y)|. $$

    We also have 

    $$(q_y - p_y) (u_x - u'_x) - (q_x - p_x) (u_y - u'_y) =
       orient(u, p, q) - orient(u', p, q) = $$
    $$2 d(u, pq) \lVert p - q \rVert - 2 d(u', pq) \lVert p - q \rVert = 
        2 \lVert p - q \rVert (d(u, pq) - d(u', pq)). $$

    Taking this together yields

    $$d(u, pq) - d(u', pq) \leq 
       |\theta|\frac{|(q_x - p_x) (u_y - u'_y)|}{2 \lVert p - q \rVert} \leq$$
    $$\frac{1}{2}|\theta| |u_y - u'_y| \leq |\theta|M.$$

    So we obtain $\hat{u}'$ by moving $u'$ perpendicular to $pq$ by at least
    $|\theta|M$.
\end{proof}

\subsection{Numerical Stability of Quickhull}

In a similar vein to \cite{Jiang06}, we define error between two sets
$P$ and $P'$ as their Hausdorff distance divided by the maximum absolute
value over their $x$-coordinates and $y$-coordinates $M$. We do not require
the number of points to be the same as we have decided to not care about
minimum representations of the convex hull.

\begin{theorem}
    Writing $\epsilon$ for the machine precision, we have implemented
    Quickhull in such a way that for recursion depth $1$, Quickhull has
    forward and backward error 

    $$\frac{6\epsilon}{1 - 6\epsilon}M.$$
\end{theorem}

\begin{proof}

\end{proof}
